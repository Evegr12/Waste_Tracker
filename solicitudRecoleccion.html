<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitar Recolección de Residuos</title>
    <link rel="stylesheet" href="solicitudRecoleccion.css">
</head>
<body>
    <header>
        <div class="logo">
            <a href="inicioRestaurante.html"><img src="logoWT.png" alt="Waste Tracker"></a>
            <h1>Waste Tracker</h1>
        </div>
        <nav>
            <a href="notificaciones.html"><img src="notificaciones.png" alt="Notificaciones"></a>
            <a href="historial.html"><img src="historial-icon.png" alt="Historial"></a>
            <a href="perfilRestaurante.html"><img src="perfil-icon.png" alt="Perfil"></a>
        </nav>
    </header>

    <div class="container">
        <h1>Solicitar recolección</h1><br>
        <div class="header">
            <img src="kingfish.png" alt="Restaurant Logo" class="restaurant-logo">
            <h1>King Fish</h1>
        </div>
        <div class="content">
            <label class="switch">
                <input type="checkbox" id="toggle">
                <span class="slider round"></span>
            </label>
            <p>Bote lleno</p>
            <button class="confirm-btn">Confirma tu recolección</button>
        </div>
    </div>

    <footer>
        <nav class="footer-nav">
            <a href="inicioRestaurante.html"><img src="home-icon.png" alt="Inicio"></a>
            <a href="solicitudRecoleccion.html"><img src="bote-icon.png" alt="Bote"></a>
            <a href="calificaciones.html"><img src="calif-icon.png" alt="Calificar"></a>
        </nav>
    </footer>

    <script>
            document.addEventListener('DOMContentLoaded', function() {
    const toggleSwitch = document.getElementById('toggle');
    const confirmButton = document.querySelector('.confirm-btn');
    confirmButton.style.opacity = '0.5';

    // Evento para manejar el cambio de estado del switch
    toggleSwitch.addEventListener('change', function() {
        confirmButton.style.opacity = this.checked ? '1' : '0.5';
    });

    // Función para obtener las coordenadas del usuario
    function obtenerCoordenadas() {
        return new Promise((resolve, reject) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        resolve(coords);
                    },
                    (error) => {
                        reject(error);
                    }
                );
            } else {
                reject(new Error('La geolocalización no es soportada por este navegador.'));
            }
        });
    }

    // Función para guardar notificaciones en el localStorage
    function guardarNotificacion(mensaje, fechaHora) {
        let notificaciones = JSON.parse(localStorage.getItem('notificaciones')) || [];
        notificaciones.push({ mensaje, fechaHora });
        localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
    }

    // Función para verificar si ya existe una solicitud activa o pendiente
    async function verificarSolicitudExistente() {
        const restaurantes_id = localStorage.getItem('restaurantes_id');
        
        try {
            const response = await fetch(`http://localhost:8080/solicitud-actual/${restaurantes_id}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token'),
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`Error del servidor: ${response.statusText}`);
            }

            const data = await response.json();
            return data.tieneSolicitudPendiente;
        } catch (error) {
            console.error('Error al verificar la solicitud existente:', error);
            return false;
        }
    }

    // Al hacer clic en el botón de confirmación
    confirmButton.addEventListener('click', async function(event) {
        if (!toggleSwitch.checked) {
            event.preventDefault();
            alert('Por favor, activa el switch para confirmar la recolección.');
            return;
        }

        // Verificar si ya hay una solicitud activa
        const tieneSolicitudPendiente = await verificarSolicitudExistente();
        if (tieneSolicitudPendiente) {
            alert('Ya tienes una solicitud de recolección pendiente. Por favor, espera a que sea completada antes de realizar otra.');
            return;
        }

        try {
            // Obtener coordenadas del usuario
            const coordenadas = await obtenerCoordenadas();

            // Obtener el ID del restaurante y la dirección desde el localStorage
            const restaurantes_id = localStorage.getItem('restaurantes_id');
            const direccion = localStorage.getItem('direccion');

            // Validar que ambos valores existan antes de enviar la solicitud
            if (!restaurantes_id || !direccion) {
                alert('Error: No se pudo encontrar la información del restaurante o la dirección. Por favor, revisa e intenta de nuevo.');
            } else {
                // Si los valores existen, enviar la solicitud al servidor
                fetch('/solicitar-recoleccion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({
                        restaurantes_id: restaurantes_id,
                        direccion: direccion,
                        lat: coordenadas.lat,
                        lon: coordenadas.lon,
                        estado: "pendiente"
                    })
                })
                .then(response => response.json())
                .then(async data => {
                    if (data.message) {
                        // Obtener el mensaje con ID=1
                        const mensajeResponse = await fetch('/mensaje-recoleccion/1', {
                            method: 'GET',
                            headers: {
                                'Authorization': 'Bearer ' + localStorage.getItem('token')
                            }
                        });

                        const mensajeData = await mensajeResponse.json();
                        if (mensajeData.texto) {
                            const fechaHora = new Date().toLocaleString();
                            guardarNotificacion(mensajeData.texto, fechaHora); // Guardar la notificación con la fecha y hora
                            window.location.href = 'inicioRestaurante.html'; // Redirigir a la página de inicio
                        }
                    } else {
                        alert('Error al enviar la solicitud.');
                    }
                })
                .catch(error => {
                    console.error('Error al enviar la solicitud:', error);
                    alert('Hubo un error al enviar la solicitud. Por favor, intenta de nuevo.');
                });
            }
        } catch (error) {
            console.error('Error al obtener las coordenadas:', error);
            alert('Hubo un error al obtener las coordenadas. Por favor, activa la geolocalización e intenta de nuevo.');
        }
    });
});

    </script>
</body>
</html>
